applications:
  # ARGOCD
  - name: argocd
    namespace: argocd
    destination:
      namespace: argocd
      server: https://kubernetes.default.svc
    project: argocd
    sources:
      - repoURL: https://argoproj.github.io/argo-helm
        chart: argo-cd
        targetRevision: 5.42.2
        helm:
          valueFiles:
          - $values/argocd/argocd/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    ignoreDifferences:
      - kind: Secret
        name: argocd-secret
        namespace: argocd
        jsonPointers:
          - /data
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - RespectIgnoreDifferences=true

  - name: argocd-apps
    namespace: argocd
    destination:
      namespace: argocd
      server: https://kubernetes.default.svc
    project: argocd
    sources:
      - repoURL: https://argoproj.github.io/argo-helm
        chart: argocd-apps
        targetRevision: 1.4.1
        helm:
          valueFiles:
          - $values/argocd/argocd-apps/values.yaml
          - $values/argocd/argocd-apps/projects.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy: {}

  # CILIUM
  - name: cilium
    namespace: argocd
    destination:
      namespace: kube-system
      server: https://kubernetes.default.svc
    project: system
    sources:
      - repoURL: https://helm.cilium.io
        chart: cilium
        targetRevision: 1.14.0
        helm:
          valueFiles:
          - $values/cilium/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    ignoreDifferences:
      - kind: Secret
        name: cilium-ca
        namespace: kube-system
        jsonPointers:
          - /data
      - kind: Secret
        name: hubble-ca-secret
        namespace: kube-system
        jsonPointers:
          - /data
      - kind: Secret
        name: hubble-server-certs
        namespace: kube-system
        jsonPointers:
          - /data
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - RespectIgnoreDifferences=true

# CERT-MANAGER
  - name: cert-manager
    namespace: argocd
    destination:
      namespace: cert-manager
      server: https://kubernetes.default.svc
    project: system
    sources:
      - repoURL: https://charts.jetstack.io
        chart: cert-manager
        targetRevision: v1.12.3
        helm:
          valueFiles:
          - $values/cert-manager/cert-manager/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

  - name: cluster-issuer
    namespace: argocd
    destination:
      namespace: cert-manager
      server: https://kubernetes.default.svc
    project: system
    sources:
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        path: cert-manager/cluster-issuer
        helm:
          valueFiles:
          - values.yaml
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# METALLB
  - name: metallb
    namespace: argocd
    destination:
      namespace: metallb
      server: https://kubernetes.default.svc
    project: system
    sources:
      - repoURL: https://metallb.github.io/metallb
        chart: metallb
        targetRevision: 0.13.10
        helm:
          valueFiles:
          - $values/metallb/metallb/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    ignoreDifferences:
      - kind: CustomResourceDefinition
        group: "apiextensions.k8s.io"
        name: bgppeers.metallb.io
        jsonPointers:
          - /spec/conversion/webhook/clientConfig/caBundle
      - kind: CustomResourceDefinition
        group: "apiextensions.k8s.io"
        name: addresspools.metallb.io
        jsonPointers:
          - /spec/conversion/webhook/clientConfig/caBundle
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true
        - RespectIgnoreDifferences=true

  - name: metallb-ipaddress-pool
    namespace: argocd
    destination:
      namespace: metallb
      server: https://kubernetes.default.svc
    project: system
    sources:
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        path: metallb/metallb-ipaddresspool
        helm:
          valueFiles:
          - values.yaml
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# TRAEFIK
  - name: traefik
    namespace: argocd
    destination:
      namespace: traefik
      server: https://kubernetes.default.svc
    project: system
    sources:
      - repoURL: https://traefik.github.io/charts
        chart: traefik
        targetRevision: 24.0.0
        helm:
          valueFiles:
          - $values/traefik/traefik/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

  - name: traefik-dashboard
    namespace: argocd
    destination:
      namespace: traefik
      server: https://kubernetes.default.svc
    project: system
    sources:
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        path: traefik/traefik-dashboard
        helm:
          valueFiles:
          - values.yaml
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# K8S SIGS
  - name: metrics-server
    namespace: argocd
    destination:
      namespace: kube-system
      server: https://kubernetes.default.svc
    project: system
    sources:
      - repoURL: https://kubernetes-sigs.github.io/metrics-server
        chart: metrics-server
        targetRevision: 3.11.0
        helm:
          valueFiles:
          - $values/k8s-sigs/metrics-server/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

  - name: kubernetes-dashboard
    namespace: argocd
    destination:
      namespace: kubernetes-dashboard
      server: https://kubernetes.default.svc
    project: system
    sources:
      - repoURL: https://kubernetes.github.io/dashboard
        chart: kubernetes-dashboard
        targetRevision: 6.0.8
        helm:
          valueFiles:
          - $values/k8s-sigs/kubernetes-dashboard/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

  - name: secrets-store-csi-driver
    namespace: argocd
    destination:
      namespace: kube-system
      server: https://kubernetes.default.svc
    project: system
    sources:
      - repoURL: https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts
        chart: secrets-store-csi-driver
        targetRevision: 1.3.4
        helm:
          valueFiles:
          - $values/k8s-sigs/secrets-store-csi-driver/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# LONGHORN
  - name: longhorn
    namespace: argocd
    destination:
      namespace: longhorn-system
      server: https://kubernetes.default.svc
    project: system
    sources:
      - repoURL: https://charts.longhorn.io
        chart: longhorn
        targetRevision: 1.5.1
        helm:
          valueFiles:
          - $values/longhorn/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# VAULT
  - name: vault
    namespace: argocd
    destination:
      namespace: vault
      server: https://kubernetes.default.svc
    project: vault
    sources:
      - repoURL: https://helm.releases.hashicorp.com
        chart: vault
        targetRevision: 0.25.0
        helm:
          valueFiles:
          - $values/vault/vault/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    ignoreDifferences:
      - group: admissionregistration.k8s.io
        kind: MutatingWebhookConfiguration
        jqPathExpressions:
        - .webhooks[]?.clientConfig.caBundle
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true
        - RespectIgnoreDifferences=true

  - name: secrets-stores
    namespace: argocd
    destination:
      namespace: vault
      server: https://kubernetes.default.svc
    project: vault
    sources:
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        path: vault/secrets-stores
        helm:
          valueFiles:
          - values.yaml
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# KUBE-PROMETHEUS-STACK
  - name: prometheus-stack
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    sources:
      - repoURL: https://prometheus-community.github.io/helm-charts
        chart: kube-prometheus-stack
        targetRevision: 48.3.1
        helm:
          skipCrds: true
          valueFiles:
          - $values/monitoring/prometheus-stack/alertmanager.yaml
          - $values/monitoring/prometheus-stack/alertmanagerconfig.yaml
          - $values/monitoring/prometheus-stack/grafana.yaml
          - $values/monitoring/prometheus-stack/ksm.yaml
          - $values/monitoring/prometheus-stack/node-exporter.yaml
          - $values/monitoring/prometheus-stack/prometheus.yaml
          - $values/monitoring/prometheus-stack/promrules.yaml
          - $values/monitoring/prometheus-stack/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    ignoreDifferences:
      - group: admissionregistration.k8s.io
        kind: MutatingWebhookConfiguration
        jqPathExpressions:
          - '.webhooks[]?.clientConfig.caBundle'
          - '.webhooks[]?.failurePolicy'
      - group: admissionregistration.k8s.io
        kind: ValidatingWebhookConfiguration
        jqPathExpressions:
          - '.webhooks[]?.clientConfig.caBundle'
          - '.webhooks[]?.failurePolicy'
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true
        - RespectIgnoreDifferences=true

  - name: prometheus-stack-crds
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    source:
      repoURL: https://github.com/prometheus-community/helm-charts.git
      path: charts/kube-prometheus-stack/charts/crds/
      directory:
        recurse: true
    syncPolicy:
      syncOptions:
        - CreateNamespace=true
        - Replace=true
      automated:
        prune: true
        selfHeal: true

# EXPORTERS
  - name: blackbox-exporter
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    sources:
      - repoURL: https://prometheus-community.github.io/helm-charts
        chart: prometheus-blackbox-exporter
        targetRevision: 8.2.0
        helm:
          valueFiles:
          - $values/monitoring/exporters/blackbox-exporter/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

  - name: nginx-exporter
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    sources:
      - repoURL: https://prometheus-community.github.io/helm-charts
        chart: prometheus-nginx-exporter
        targetRevision: 0.1.1
        helm:
          valueFiles:
          - $values/monitoring/exporters/nginx-exporter/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

  - name: pihole-exporter
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    sources:
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        path: monitoring/exporters/pihole-exporter
        helm:
          valueFiles:
          - values.yaml
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# ROBUSTA

  - name: robusta
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    sources:
      - repoURL: https://robusta-charts.storage.googleapis.com
        chart: robusta
        targetRevision: 0.10.21
        helm:
          valueFiles:
          - $values/monitoring/robusta/robusta/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

  - name: robusta-secret-init
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    sources:
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        path: monitoring/robusta/robusta-secret-init
        helm:
          valueFiles:
          - values.yaml
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# MINIO
  - name: minio
    namespace: argocd
    destination:
      namespace: minio
      server: https://kubernetes.default.svc
    project: minio
    sources:
      - repoURL: registry-1.docker.io
        chart: bitnamicharts/minio
        targetRevision: 12.6.12
        helm:
          valueFiles:
          - $values/minio/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# OPEN TELEMETRY
  - name: opentelemetry-operator
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    sources:
      - repoURL: https://open-telemetry.github.io/opentelemetry-helm-charts
        chart: opentelemetry-operator
        targetRevision: 0.34.1
        helm:
          valueFiles:
          - $values/monitoring/opentelemetry/opentelemetry-operator/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

  - name: opentelemetry-collector
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    sources:
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        path: monitoring/opentelemetry/opentelemetry-collector
        helm:
          valueFiles:
          - values.yaml
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# LOKI
  - name: loki
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    sources:
      - repoURL: https://grafana.github.io/helm-charts
        chart: loki
        targetRevision: 5.10.0
        helm:
          valueFiles:
          - $values/monitoring/loki/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

  - name: promtail
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    sources:
      - repoURL: https://grafana.github.io/helm-charts
        chart: promtail
        targetRevision: 6.14.1
        helm:
          valueFiles:
          - $values/monitoring/promtail/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# TEMPO
  - name: tempo
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    sources:
      - repoURL: https://grafana.github.io/helm-charts
        chart: tempo
        targetRevision: 1.5.0
        helm:
          valueFiles:
          - $values/monitoring/tempo/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# SLOTH
  - name: sloth
    namespace: argocd
    destination:
      namespace: monitoring
      server: https://kubernetes.default.svc
    project: monitoring
    sources:
      - repoURL: https://slok.github.io/sloth
        chart: sloth
        targetRevision: 0.7.0
        helm:
          valueFiles:
          - $values/monitoring/sloth/sloth/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# KYVERNO
  - name: kyverno
    namespace: argocd
    destination:
      namespace: kyverno
      server: https://kubernetes.default.svc
    project: kyverno
    sources:
      - repoURL: https://kyverno.github.io/kyverno
        chart: kyverno
        targetRevision: 3.0.4
        helm:
          valueFiles:
          - $values/kyverno/kyverno/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true
        - Replace=true

  - name: kyverno-policies
    namespace: argocd
    destination:
      namespace: kyverno
      server: https://kubernetes.default.svc
    project: kyverno
    sources:
      - repoURL: https://kyverno.github.io/kyverno
        chart: kyverno-policies
        targetRevision: 3.0.3
        helm:
          valueFiles:
          - $values/kyverno/kyverno-policies/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

# Security
  - name: trivy-operator
    namespace: argocd
    destination:
      namespace: trivy
      server: https://kubernetes.default.svc
    project: security
    sources:
      - repoURL: https://aquasecurity.github.io/helm-charts/
        chart: trivy-operator
        targetRevision: 0.15.1
        helm:
          valueFiles:
          - $values/security/trivy-operator/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true

  - name: polaris
    namespace: argocd
    destination:
      namespace: polaris
      server: https://kubernetes.default.svc
    project: security
    sources:
      - repoURL: https://charts.fairwinds.com/stable
        chart: polaris
        targetRevision: 5.11.2
        helm:
          valueFiles:
          - $values/security/polaris/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true




# Examples
  - name: opentelemetry-demo
    namespace: argocd
    destination:
      namespace: example
      server: https://kubernetes.default.svc
    project: example
    sources:
      - repoURL: https://open-telemetry.github.io/opentelemetry-helm-charts
        chart: opentelemetry-demo
        targetRevision: 0.22.4
        helm:
          valueFiles:
          - $values/example/opentelemetry-demo/values.yaml
      - repoURL: git@github.com:thibaultserti/kubernetes.git
        targetRevision: HEAD
        ref: values
    syncPolicy:
      automated:
        selfHeal: true
        prune: true
      syncOptions:
        - CreateNamespace=true
