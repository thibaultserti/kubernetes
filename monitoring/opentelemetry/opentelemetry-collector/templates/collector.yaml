apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: otel
  labels:
    app.kubernetes.io/name: otel-collector

spec:
  serviceAccount: otel-collector
  # targetAllocator:
  #   enabled: true
  mode: daemonset
  ports:
    - name: loki-http
      port: 3500
      protocol: TCP
    - name: loki-grpc
      port: 3600
      protocol: TCP
    - name: prometheus
      port: 9464
      protocol: TCP
  ingress:
    type: ingress
    ingressClassName: "traefik"
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: web, websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hostname: otel.ayanides.cloud
    tls:
      - secretName: otel-collector-tls
        hosts:
          - otel.ayanides.cloud
  config: |
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
            cors:
              allowed_origins:
                - "http://*"
                - "https://*"
      loki:
        protocols:
          http:
            endpoint: 0.0.0.0:3500
          grpc:
            endpoint: 0.0.0.0:3600
        use_incoming_timestamp: true

    exporters:
      otlp:
        endpoint: tempo.monitoring:4317
        tls:
          insecure: true

      # prometheus:
      #   endpoint: 0.0.0.0:9464
      #   resource_to_telemetry_conversion:
      #     enabled: true
      #   enable_open_metrics: true

      loki:
        endpoint: "http://loki.monitoring:3100/loki/api/v1/push"


    processors:
      batch:
      memory_limiter:
        check_interval: 1s
        limit_percentage: 50
        spike_limit_percentage: 30
      k8sattributes:
        filter:
          node_from_env_var: K8S_NODE_NAME
        passthrough: false
        pod_association:
        - sources:
          - from: resource_attribute
            name: k8s.pod.ip
        - sources:
          - from: resource_attribute
            name: k8s.pod.uid
        - sources:
          - from: connection
        extract:
          metadata:
            - "k8s.namespace.name"
            - "k8s.deployment.name"
            - "k8s.statefulset.name"
            - "k8s.daemonset.name"
            - "k8s.cronjob.name"
            - "k8s.job.name"
            - "k8s.node.name"
            - "k8s.pod.name"
            - "k8s.pod.uid"
            - "k8s.pod.start_time"
          labels:
            - tag_name: $$1
              key_regex: (.*)
              from: pod
          annotations:
            - tag_name: $$1
              key_regex: (.*)
              from: pod

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [k8sattributes, memory_limiter, batch]
          exporters: [otlp]
        # metrics:
        #   receivers: [otlp]
        #   processors: [k8sattributes, memory_limiter, batch]
        #   exporters: [prometheus]
        logs:
          receivers: [loki]
          processors: [k8sattributes, memory_limiter, batch]
          exporters: [loki]
